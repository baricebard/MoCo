# 裝置感測器整合實作
1. DeviceMotionEvent  
2. DeviceOrientationEvent  

## DeviceMotion
### DeviceMotion 是什麼？（基礎說明）

DeviceMotionEvent 提供手機的運動與旋轉資訊，可取得：  

- acceleration.x / y / z（加速度）
- accelerationIncludingGravity.x / y / z（包含重力）
- rotationRate.alpha / beta / gamma（旋轉角速度）
- interval（更新頻率 ms）  

用途：
- 手機搖晃偵測
- 遊戲控制（左右傾斜、搖動）
- 手勢操作

### 使用者授權（非常重要）
iOS（Safari）
- 必須在 **使用者操作（click/touch）**後 呼叫 
    DeviceMotionEvent.requestPermission()
- 未授權 → 永遠不會觸發事件（無錯誤）

Android（Chrome）
- 不需要 requestPermission（2025 年仍維持）

### DeviceMotion 提供的資料（快速）

| 欄位                                   | 說明             |
| ------------------------------------ | -------------- |
| `event.acceleration`                 | 不含重力的加速度（m/s²） |
| `event.accelerationIncludingGravity` | 含重力（9.8m/s²）   |
| `event.rotationRate.alpha`           | Z 軸旋轉（度/秒）     |
| `event.rotationRate.beta`            | X 軸旋轉          |
| `event.rotationRate.gamma`           | Y 軸旋轉          |
| `event.interval`                     | 更新頻率（ms）       |

### 範例
```JavaScript
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>DeviceMotion Demo</title>
<style>
  body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
  button { padding: 10px 20px; font-size: 16px; }
  pre { background: #f3f3f3; padding: 10px; border-radius: 6px; }
</style>
</head>
<body>

<h2>DeviceMotion 測試頁面</h2>
<p>請點擊下方按鈕授權存取行動裝置感測器。</p>

<button id="btn">啟用 DeviceMotion</button>

<h3>感測器資料：</h3>
<pre id="output">尚未啟用</pre>

<script>
async function requestPermissionIfNeeded() {
  // 非 iOS：不需要任何授權流程
  if (typeof DeviceMotionEvent.requestPermission !== "function") {
    return "granted";
  }

  // iOS：必須在使用者操作後呼叫
  try {
    const state = await DeviceMotionEvent.requestPermission();
    return state; // "granted" 或 "denied"
  } catch (err) {
    return "denied";
  }
}

document.getElementById("btn").addEventListener("click", async () => {
  const result = await requestPermissionIfNeeded();

  if (result !== "granted") {
    document.getElementById("output").textContent = "使用者拒絕授權或未允許感測器存取。";
    return;
  }

  document.getElementById("output").textContent = "等待 DeviceMotion 資料…";

  window.addEventListener("devicemotion", event => {
    const acc = event.acceleration;
    const accG = event.accelerationIncludingGravity;
    const rot = event.rotationRate;

    document.getElementById("output").textContent =
      `加速度（不含重力）:
  x: ${acc?.x?.toFixed(3)}  
  y: ${acc?.y?.toFixed(3)}
  z: ${acc?.z?.toFixed(3)}

加速度（含重力）:
  x: ${accG?.x?.toFixed(3)}
  y: ${accG?.y?.toFixed(3)}
  z: ${accG?.z?.toFixed(3)}

旋轉速度:
  alpha(Z): ${rot?.alpha?.toFixed(3)}
  beta(X):  ${rot?.beta?.toFixed(3)}
  gamma(Y): ${rot?.gamma?.toFixed(3)}

更新頻率: ${event.interval} ms
`;
  });
});
</script>

</body>
</html>

```

## DeviceOrientation

### DeviceOrientation 是什麼？  

瀏覽器提供能讀取手機方向角度的 API。包含三個主要角度：  

| 軸         | 名稱    | 意義              |
| --------- | ----- | --------------- |
| α (alpha) | Z 軸旋轉 | 手機水平旋轉：0°–360°  |
| β (beta)  | X 軸旋轉 | 前後傾斜：-180°–180° |
| γ (gamma) | Y 軸旋轉 | 左右傾斜：-90°–90°   |

**✔ 支援情況（2025）**

- Mobile Chrome / Android：需要使用者手動授權 (requestPermission)
- Safari / iOS 13+：強制需要使用者授權
- 桌面電腦通常無法測試（無 sensor）

### 使用者授權流程

標準流程需檢查：
1. DeviceOrientationEvent 是否存在  
2. 是否需要 DeviceOrientationEvent.requestPermission() 
3. 等使用者按按鈕 → 才能開啟監聽事件

### 範例
```HTML
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DeviceOrientation Demo</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    line-height: 1.8;
  }
  #values {
    margin-top: 20px;
    font-size: 1.2rem;
  }
  button {
    padding: 10px 18px;
    font-size: 1.1rem;
  }
</style>
</head>
<body>

<h2>DeviceOrientation Demo</h2>
<p>按下按鈕以取得感測器使用權限並開始讀取 α/β/γ。</p>

<button id="btn">取得授權並開始</button>

<div id="values">
  <p>Alpha (Z 軸): <span id="alpha">-</span></p>
  <p>Beta (X 軸): <span id="beta">-</span></p>
  <p>Gamma (Y 軸): <span id="gamma">-</span></p>
</div>

<script>
  const btn = document.getElementById("btn");
  const alphaEl = document.getElementById("alpha");
  const betaEl = document.getElementById("beta");
  const gammaEl = document.getElementById("gamma");

  btn.addEventListener("click", async () => {
    try {
      // 1. 檢查 API 是否存在
      if (typeof DeviceOrientationEvent === "undefined") {
        alert("此裝置不支援 DeviceOrientation");
        return;
      }

      // 2. iOS / Android Chrome 需進行授權
      if (typeof DeviceOrientationEvent.requestPermission === "function") {
        const state = await DeviceOrientationEvent.requestPermission();
        if (state !== "granted") {
          alert("使用者未允許存取感測器");
          return;
        }
      }

      // 3. 監聽事件
      window.addEventListener("deviceorientation", (event) => {
        const a = event.alpha;
        const b = event.beta;
        const g = event.gamma;

        alphaEl.textContent = a ? a.toFixed(2) : "-";
        betaEl.textContent = b ? b.toFixed(2) : "-";
        gammaEl.textContent = g ? g.toFixed(2) : "-";
      });

      btn.disabled = true;
      btn.textContent = "已啟動感測器";

    } catch (err) {
      alert("啟動感測器時發生錯誤：" + err);
    }
  });
</script>

</body>
</html>
```


### DeviceOrientation + DeviceMotion  

API 比較及說明  
| API                   | 用途             | 回傳內容                                                   |
| --------------------- | -------------- | ------------------------------------------------------ |
| **DeviceOrientation** | 讀取手機「方向角度」     | α：Z 軸旋轉、β：前後、γ：左右                                      |
| **DeviceMotion**      | 讀取「加速度」與「旋轉速率」 | acceleration、accelerationIncludingGravity、rotationRate |

兩者常一起使用，例如：

- 做體感遊戲（方向角控制 + 位移偵測）
- 3D 模型同步旋轉
- AR 模擬相機角度
- 手機搖動偵測（Motion）＋ 指向方向（Orientation）


### 授權步驟

在 2025 的 Chrome/ Safari：  

✔ 一定要按下按鈕 → 觸發 requestPermission()  
✔ DeviceOrientation 和 DeviceMotion 都要分別授權  

流程：  

1. 檢查 DeviceOrientationEvent 和 DeviceMotionEvent 是否存在  
2. 若存在 .requestPermission() → 要求使用者允許  
3. 允許後再開始監聽 event listener  

### 整合流程及目標  
1. 按下按鈕
2. 執行 async function 取得兩個 API 的 permission  
3. 成功後加入監聽
4. 在畫面顯示以下資料：
    - α、β、γ
    - 加速度 ax, ay, az
    - 含重力加速度 ax_g, ay_g, az_g
    - 旋轉速率（陀螺儀）alphaRate, betaRate, gammaRate

```HTML
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Orientation + Motion Demo</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.8; }
    button { padding: 10px 18px; font-size: 1.2rem; }
    h3 { margin-top: 30px; }
    .val { font-size: 1.1rem; }
</style>
</head>
<body>

<h2>DeviceOrientation + DeviceMotion 整合示範</h2>
<p>請按下按鈕授權後，旋轉手機與搖一搖。</p>

<button id="btn">取得感測器授權並開始</button>

<h3>DeviceOrientation (方向角度)</h3>
<p class="val">Alpha (Z)：<span id="alpha">-</span></p>
<p class="val">Beta (X)：<span id="beta">-</span></p>
<p class="val">Gamma (Y)：<span id="gamma">-</span></p>

<h3>DeviceMotion (加速度)</h3>
<p class="val">ax：<span id="ax">-</span></p>
<p class="val">ay：<span id="ay">-</span></p>
<p class="val">az：<span id="az">-</span></p>

<h3>DeviceMotion (含重力)</h3>
<p class="val">ax_g：<span id="ax_g">-</span></p>
<p class="val">ay_g：<span id="ay_g">-</span></p>
<p class="val">az_g：<span id="az_g">-</span></p>

<h3>Gyroscope 旋轉速率</h3>
<p class="val">α(速度)：<span id="rAlpha">-</span></p>
<p class="val">β(速度)：<span id="rBeta">-</span></p>
<p class="val">γ(速度)：<span id="rGamma">-</span></p>

<script>
const btn = document.getElementById("btn");

// Orientation
const alphaEl = document.getElementById("alpha");
const betaEl  = document.getElementById("beta");
const gammaEl = document.getElementById("gamma");

// Acceleration
const axEl = document.getElementById("ax");
const ayEl = document.getElementById("ay");
const azEl = document.getElementById("az");

// Acceleration including gravity
const axgEl = document.getElementById("ax_g");
const aygEl = document.getElementById("ay_g");
const azgEl = document.getElementById("az_g");

// Rotation rate
const rAlphaEl = document.getElementById("rAlpha");
const rBetaEl  = document.getElementById("rBeta");
const rGammaEl = document.getElementById("rGamma");

btn.addEventListener("click", async () => {
    try {
        // 檢查支援度
        if (!window.DeviceMotionEvent && !window.DeviceOrientationEvent) {
            alert("此裝置不支援 Motion/Orientation 感測器");
            return;
        }

        // ======== Orientation 授權 ========
        if (typeof DeviceOrientationEvent?.requestPermission === "function") {
            const r1 = await DeviceOrientationEvent.requestPermission();
            if (r1 !== "granted") {
                alert("未允許讀取 DeviceOrientation");
                return;
            }
        }

        // ======== Motion 授權 ========
        if (typeof DeviceMotionEvent?.requestPermission === "function") {
            const r2 = await DeviceMotionEvent.requestPermission();
            if (r2 !== "granted") {
                alert("未允許讀取 DeviceMotion");
                return;
            }
        }

        // ======== DeviceOrientation Listener ========
        window.addEventListener("deviceorientation", (event) => {
            alphaEl.textContent = event.alpha?.toFixed(2) ?? "-";
            betaEl.textContent  = event.beta?.toFixed(2) ?? "-";
            gammaEl.textContent = event.gamma?.toFixed(2) ?? "-";
        });

        // ======== DeviceMotion Listener ========
        window.addEventListener("devicemotion", (event) => {
            const acc = event.acceleration || {};
            axEl.textContent = acc.x?.toFixed(2) ?? "-";
            ayEl.textContent = acc.y?.toFixed(2) ?? "-";
            azEl.textContent = acc.z?.toFixed(2) ?? "-";

            const accG = event.accelerationIncludingGravity || {};
            axgEl.textContent = accG.x?.toFixed(2) ?? "-";
            aygEl.textContent = accG.y?.toFixed(2) ?? "-";
            azgEl.textContent = accG.z?.toFixed(2) ?? "-";

            const rot = event.rotationRate || {};
            rAlphaEl.textContent = rot.alpha?.toFixed(2) ?? "-";
            rBetaEl.textContent  = rot.beta?.toFixed(2) ?? "-";
            rGammaEl.textContent = rot.gamma?.toFixed(2) ?? "-";
        });

        btn.disabled = true;
        btn.textContent = "感測器已啟動";

    } catch (err) {
        alert("錯誤：" + err);
    }
});
</script>

</body>
</html>
```