# 位置服務與感測資料整合

## 地理位置API介紹  

1. 什麼是navigator.geolocation  
- 瀏覽器內建的地理位置API  
- 需要使用者授權才能使用  
- 提供經緯度、精度、海拔等資訊  

2. 基本語法  
```JavaScript
// 檢查瀏覽器支援
if ("geolocation" in navigator) {
  console.log("地理位置服務可用");
} else {
  console.log("地理位置服務不可用");
}

// 取得當前位置
navigator.geolocation.getCurrentPosition(
  (position) => {
    console.log("位置取得成功:", position);
  },
  (error) => {
    console.log("位置取得失敗:", error);
  }
);
```
3. Position物件解析
```JavaScript
function handlePosition(position) {
  const coords = position.coords;
  
  console.log("緯度:", coords.latitude);
  console.log("經度:", coords.longitude);
  console.log("精度:", coords.accuracy); // 公尺
  console.log("海拔:", coords.altitude);
  console.log("海拔精度:", coords.altitudeAccuracy);
  console.log("方向:", coords.heading); // 度數，0=正北
  console.log("速度:", coords.speed); // 公尺/秒
}
```
## 裝置感測器介紹 
1. 加速度感測器  
```JavaScript
// 檢查支援度
if ("DeviceMotionEvent" in window) {
  console.log("加速度感測器可用");
  
  window.addEventListener("devicemotion", (event) => {
    const acceleration = event.acceleration; // 不含重力
    const accelerationIncludingGravity = event.accelerationIncludingGravity; // 含重力
    
    console.log("X軸加速度:", acceleration.x);
    console.log("Y軸加速度:", acceleration.y);
    console.log("Z軸加速度:", acceleration.z);
  });
}
```
2. 方向感測器  
```JavaScript
// 檢查支援度
if ("DeviceOrientationEvent" in window) {
  console.log("方向感測器可用");
  
  window.addEventListener("deviceorientation", (event) => {
    console.log("Alpha (Z軸旋轉):", event.alpha); // 0-360度
    console.log("Beta (X軸旋轉):", event.beta);   // -180到180度
    console.log("Gamma (Y軸旋轉):", event.gamma); // -90到90度
  });
}
```
3. 權限請求
```JavaScript
// 請求感測器權限（部分瀏覽器需要）
async function requestSensorPermissions() {
  try {
    if (navigator.permissions) {
      await navigator.permissions.query({ name: 'accelerometer' });
      await navigator.permissions.query({ name: 'gyroscope' });
    }
  } catch (error) {
    console.log("權限請求可能不被支援");
  }
}
```
## 整合實作
1. 完整的權限管理與裝置狀態物件
```JavaScript
class DeviceStateManager {
  constructor() {
    this.state = {
      lat: null,
      lon: null,
      accel: { x: null, y: null, z: null },
      orientation: { alpha: null, beta: null, gamma: null }
    };
    
    this.permissionsGranted = {
      geolocation: false,
      motion: false,
      orientation: false
    };
    
    this.init();
  }
  
  async init() {
    try {
      // 依序請求權限
      await this.requestPermissions();
      this.setupGeolocation();
      this.setupSensors();
    } catch (error) {
      console.error("初始化失敗:", error);
    }
  }
  
  async requestPermissions() {
    // 請求地理位置權限
    try {
      const geoPermission = await navigator.permissions.query({ name: 'geolocation' });
      this.permissionsGranted.geolocation = geoPermission.state === 'granted';
      
      if (geoPermission.state === 'prompt') {
        // 透過實際呼叫來觸發權限請求
        await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            () => resolve(),
            (error) => reject(error),
            { timeout: 1000 }
          );
        });
        this.permissionsGranted.geolocation = true;
      }
    } catch (error) {
      console.log("地理位置權限請求需要使用者互動");
    }
    
    // 請求運動感測器權限
    try {
      if (navigator.permissions && navigator.permissions.query) {
        const motionPermission = await navigator.permissions.query({ name: 'accelerometer' });
        this.permissionsGranted.motion = motionPermission.state === 'granted';
        
        const orientationPermission = await navigator.permissions.query({ name: 'gyroscope' });
        this.permissionsGranted.orientation = orientationPermission.state === 'granted';
      } else {
        // 舊版瀏覽器，直接嘗試設定監聽來觸發權限請求
        this.permissionsGranted.motion = true;
        this.permissionsGranted.orientation = true;
      }
    } catch (error) {
      console.log("感測器權限API可能不被支援，嘗試直接使用");
      this.permissionsGranted.motion = true;
      this.permissionsGranted.orientation = true;
    }
  }
  
  setupGeolocation() {
    if (!("geolocation" in navigator)) {
      console.warn("地理位置API不被支援");
      return;
    }
    
    // 使用一次性位置請求來觸發權限對話框
    navigator.geolocation.getCurrentPosition(
      (position) => {
        this.updateGeolocation(position);
        // 權限獲得後開始持續監聽
        this.startGeolocationWatch();
      },
      (error) => {
        console.error("地理位置權限被拒絕或錯誤:", error);
        this.handleGeolocationError(error);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  }
  
  startGeolocationWatch() {
    this.watchId = navigator.geolocation.watchPosition(
      (position) => {
        this.updateGeolocation(position);
      },
      (error) => {
        console.error("位置監聽錯誤:", error);
      },
      {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 1000
      }
    );
  }
  
  updateGeolocation(position) {
    this.state.lat = position.coords.latitude;
    this.state.lon = position.coords.longitude;
    this.onStateUpdate();
  }
  
  setupSensors() {
    this.setupMotionSensor();
    this.setupOrientationSensor();
  }
  
  setupMotionSensor() {
    if (!("DeviceMotionEvent" in window)) {
      console.warn("DeviceMotion API不被支援");
      return;
    }
    
    // 添加事件監聽器來觸發權限請求
    const handleMotion = (event) => {
      this.state.accel = {
        x: event.accelerationIncludingGravity?.x || null,
        y: event.accelerationIncludingGravity?.y || null,
        z: event.accelerationIncludingGravity?.z || null
      };
      this.onStateUpdate();
    };
    
    // 請求權限並開始監聽
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      // iOS 13+ 需要明確請求權限
      DeviceMotionEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            window.addEventListener("devicemotion", handleMotion);
            this.permissionsGranted.motion = true;
          }
        })
        .catch(console.error);
    } else {
      // 其他瀏覽器
      window.addEventListener("devicemotion", handleMotion);
    }
  }
  
  setupOrientationSensor() {
    if (!("DeviceOrientationEvent" in window)) {
      console.warn("DeviceOrientation API不被支援");
      return;
    }
    
    const handleOrientation = (event) => {
      this.state.orientation = {
        alpha: event.alpha,
        beta: event.beta,
        gamma: event.gamma
      };
      this.onStateUpdate();
    };
    
    // 請求權限並開始監聽
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      // iOS 13+ 需要明確請求權限
      DeviceOrientationEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            window.addEventListener("deviceorientation", handleOrientation);
            this.permissionsGranted.orientation = true;
          }
        })
        .catch(console.error);
    } else {
      // 其他瀏覽器
      window.addEventListener("deviceorientation", handleOrientation);
    }
  }
  
  handleGeolocationError(error) {
    switch(error.code) {
      case error.PERMISSION_DENIED:
        console.error("使用者拒絕地理位置權限");
        break;
      case error.POSITION_UNAVAILABLE:
        console.error("無法取得位置資訊");
        break;
      case error.TIMEOUT:
        console.error("位置請求超時");
        break;
      default:
        console.error("未知錯誤:", error);
    }
  }
  
  onStateUpdate() {
    // 當狀態更新時呼叫
    console.log("裝置狀態更新:", this.getStateJSON());
    
    // 觸發自訂事件
    if (this.onUpdateCallback) {
      this.onUpdateCallback(this.state);
    }
  }
  
  getStateJSON() {
    return JSON.stringify(this.state, null, 2);
  }
  
  getState() {
    return { ...this.state };
  }
  
  setUpdateCallback(callback) {
    this.onUpdateCallback = callback;
  }
  
  // 清理資源
  destroy() {
    if (this.watchId) {
      navigator.geolocation.clearWatch(this.watchId);
    }
    // 移除感測器監聽
    window.removeEventListener("devicemotion", this.handleMotion);
    window.removeEventListener("deviceorientation", this.handleOrientation);
  }
}
```
2. 使用範例與權限觸發  
```JavaScript
// 初始化裝置狀態管理器
const deviceManager = new DeviceStateManager();

// 設定狀態更新回調
deviceManager.setUpdateCallback((state) => {
  console.log("狀態已更新:", state);
  updateDisplay(state);
});

// 手動權限請求按鈕（針對iOS等需要使用者互動的環境）
function requestPermissionsManually() {
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission()
      .then(permissionState => {
        if (permissionState === 'granted') {
          console.log("運動感測器權限已授予");
          deviceManager.setupMotionSensor();
        }
      })
      .catch(console.error);
  }
  
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(permissionState => {
        if (permissionState === 'granted') {
          console.log("方向感測器權限已授予");
          deviceManager.setupOrientationSensor();
        }
      })
      .catch(console.error);
  }
}

// 更新顯示
function updateDisplay(state) {
  const display = document.getElementById('stateDisplay');
  if (display) {
    display.textContent = JSON.stringify(state, null, 2);
  }
}

// 定期記錄狀態
setInterval(() => {
  const state = deviceManager.getState();
  console.log("當前裝置狀態:", state);
}, 5000);
```

3. HTML
```JavaScript
<!DOCTYPE html>
<html>
<head>
  <title>裝置狀態監控 - 完整權限管理</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .permission-btn { 
      background: #4CAF50; 
      color: white; 
      padding: 10px 15px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      margin: 5px; 
    }
    .permission-btn:hover { background: #45a049; }
    #stateDisplay { 
      background: #f5f5f5; 
      padding: 15px; 
      border-radius: 4px; 
      white-space: pre-wrap; 
      font-family: monospace; 
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>裝置狀態監控</h1>
    
    <div id="status">初始化中，請允許位置和感測器權限...</div>
    
    <!-- 手動權限請求按鈕（針對iOS） -->
    <div>
      <button class="permission-btn" onclick="requestPermissionsManually()">
        請求感測器權限 (iOS)
      </button>
      <button class="permission-btn" onclick="deviceManager.setupGeolocation()">
        重新請求位置權限
      </button>
    </div>
    
    <h3>即時裝置狀態：</h3>
    <pre id="stateDisplay">等待資料...</pre>
  </div>

  <script>
    // 這裡放入上面的 DeviceStateManager 類別
    
    const deviceManager = new DeviceStateManager();
    const stateDisplay = document.getElementById('stateDisplay');
    const statusDiv = document.getElementById('status');
    
    // 設定更新回調
    deviceManager.setUpdateCallback((state) => {
      stateDisplay.textContent = JSON.stringify(state, null, 2);
      statusDiv.textContent = '資料收集中...';
    });
    
    // 手動權限請求函數
    function requestPermissionsManually() {
      // 這裡放入上面的 requestPermissionsManually 函數
    }
  </script>
</body>
</html>
```
