# 表單數據

本章將介紹如何傳送 HTML 表單：包括帶文件或不帶文件、帶附加欄位等等。

FormData物件可以幫忙。顧名思義，它是表示 HTML 表單資料的物件。  

構造函數為：    
 
```JavaScript
let formData = new FormData([form]);
```

如果 HTML 提供了 `form` 元素，它會自動捕獲其欄位。

`FormData` 的特殊之處在於，諸如 `fetch`之類的網路方法可以接受一個 `FormData` 物件作為請求體。它會被編碼並隨請求體一起發送出去  
`Content-Type: multipart/form-data`。  

從伺服器的角度來看，這看起來像是一次普通的表單提交。  

## 傳送一個單的 form

我們先送出一份簡單的 form

如你所見，這幾乎就是一句簡單的句子：  

```HTML
<form id="formElem">
  <input type="text" name="name" value="John">
  <input type="text" name="surname" value="Smith">
  <input type="submit">
</form>

<script>
  formElem.onsubmit = async (e) => {
    e.preventDefault();

    let response = await fetch('/article/formdata/post/user', {
      method: 'POST',
      body: new FormData(formElem)
    });

    let result = await response.json();

    alert(result.message);
  };
</script>
```  
本例未展示伺服器端程式碼，因為它超出了本文的範圍。伺服器接受 POST 請求並回覆 `User saved`。    

## FormData 方法  

可以使用 `FormData` 以下方法修改欄位：  

- `formData.append(name, value)` – 新增一個欄位 `name`，給定值 `value`
- `formData.append(name, blob, fileName)` – 新增一個欄位，就像新增 `<input type="file">` 欄位一樣 ，第三個參數 `fileName` 設定檔案名稱（不是表單欄位名稱），也就是使用者檔案系統中的檔案名稱。
- `formData.delete(name)` – 刪除 `name` 欄位
- `formData.get(name)` – 取得 `name` 欄位的值
- `formData.has(name)` - 如果存在 `name` 欄位，則返回 `true`；否則返回 `false`    

使用 `append` 一個表單可以有多個同名欄位 `name`   

使用 `set` 方法，。會移除所有具有 `name` 欄位，然後添加一個新的 `name` 欄位。確保只有一個 `name` 欄位, 其餘操作與 `append` 相同：  

- formData.set(name, value)  
- formData.set(name, blob, fileName)  

我們也可以使用 for..of 遍歷 formData 欄位：  

```JavaScript
let formData = new FormData();
formData.append('key1', 'value1');
formData.append('key2', 'value2');

// List key/value pairs
for(let [name, value] of formData) {
  alert(`${name} = ${value}`); // key1 = value1, then key2 = value2
}
```  

## 傳送包含檔案的 form

表單始終以 `Content-Type: multipart/form-data` 格式傳送，這種編碼方式允許傳送檔案。因此，<input type="file">表單欄位也會被傳送，類似於普通的表單提交。

以下是一個此類形式的例子：
```JavaScript
<form id="formElem">
  <input type="text" name="firstName" value="John">
  Picture: <input type="file" name="picture" accept="image/*">
  <input type="submit">
</form>

<script>
  const formElem = document.getElementById("formElem");
  formElem.onsubmit = async (e) => {
    e.preventDefault();

    let response = await fetch('/article/formdata/post/user-avatar', {
      method: 'POST',
      body: new FormData(formElem)
    });

    let result = await response.json();

    alert(result.message);
  };
</script>
```

## 傳送包含 Blob 資料的 form  

發送動態生成的二進位資料（例如圖像），使用 Blob 可以非常容易做到 。我們可以直接將 Blob 作為 `fetch` 參數。

但實際上，通常比較方便的做法是，不單獨發送圖片，而是將其作為表單的一部分發送，並添加「名稱」和其他元資料等附加欄位。  

此外，伺服器通常更適合接受多部分編碼的表單，而不是原始二進位資料。  

此範例使用以下方式提交來自 `<canvas>` 的圖像 以及其他一些 `FormData` 欄位：

```JavaScript
<body style="margin:0">
  <canvas id="canvasElem" width="100" height="80" style="border:1px solid"></canvas>

  <input type="button" value="Submit" onclick="submit()">

  <script>
    const canvasElem = document.getElementById("canvasElem");

    canvasElem.onmousemove = function(e) {
      let ctx = canvasElem.getContext('2d');
      ctx.lineTo(e.clientX, e.clientY);
      ctx.stroke();
    };

    async function submit() {
      let imageBlob = await new Promise(resolve => canvasElem.toBlob(resolve, 'image/png'));

      let formData = new FormData();
      formData.append("firstName", "John");
      formData.append("image", imageBlob, "image.png");

      let response = await fetch('/article/formdata/post/image-form', {
        method: 'POST',
        body: formData
      });
      let result = await response.json();
      alert(result.message);
    }

  </script>
</body>
```  

請注意圖片的 `Blob` 添加方式：  
`formData.append("image", imageBlob, "image.png");`  

這就好比表單中有 `<input type="file" name="image">`，訪客從其文件系統中提交了一個名為 "image.png"（第三個參數）的文件，其中包含資料 imageBlob（第二個參數）。  

伺服器讀取表單資料和文件，就像處理常規表單提交一樣。    

## 總結

`FormData` 物件用於捕獲 HTML 表單，並使用 `fetch` 或其他網路方法提交它。

可以使用 `new FormData(form)` 從 HTML 表單建立對象，也可以完全不使用表單建立對象，然後使用方法新增欄位：

- formData.append(name, value)
- formData.append(name, blob, fileName)
- formData.set(name, value)
- formData.set(name, blob, fileName)

這裡有兩個特別之處：  

1. `set` 方法會刪除同名字段，而另一種方法 `append` 不會。這是它們之間唯一的區別。

2. 要傳送文件，需要使用 3 個參數的語法，最後一個參數是檔案名稱，通常從使用者檔案系統中透過 `<input type="file">` 取得  

其他方法包括：

- formData.delete(name)
- formData.get(name)
- formData.has(name)